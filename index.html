<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>COI Finder (Co-authorship)</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    textarea { width: 100%; height: 150px; }
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
  </style>
</head>
<body>
  <h1>COI Finder: Co-authorship Detector</h1>
  <p>Enter one author name per line (format: First Last)</p>
  <textarea id="authorsInput"></textarea><br><br>
  <button onclick="findConflicts()">Find Conflicts</button>
  <h2>Results:</h2>
  <div id="results"></div>

  <script>
    async function fetchPublications(authorName) {
      const url = `https://dblp.org/search/publ/api?q=author:${encodeURIComponent(authorName)}&h=1000&format=json`;
      const res = await fetch(url);
      const data = await res.json();
      const hits = data.result.hits?.hit || [];
      return hits.map(hit => ({
        title: hit.info.title,
        year: parseInt(hit.info.year),
        authors: Array.isArray(hit.info.authors?.author)
          ? hit.info.authors.author.map(a => a.text)
          : [hit.info.authors?.author?.text || ""]
      }));
    }

    async function findConflicts() {
      const input = document.getElementById("authorsInput").value.trim();
      const authorList = input.split("\n").map(a => a.trim()).filter(a => a);
      const pubMap = new Map(); // author → list of recent co-authors

      const thisYear = new Date().getFullYear();

      for (const author of authorList) {
        const pubs = await fetchPublications(author);
        const recentPubs = pubs.filter(p => thisYear - p.year <= 3);
        const coauthors = recentPubs.flatMap(p => p.authors.filter(a => a !== author));
        if (!pubMap.has(author)) pubMap.set(author, []);
        pubMap.get(author).push(...coauthors);
      }

      // Count co-authored papers between pairs
      const conflicts = [];
      const names = Array.from(pubMap.keys());
      for (let i = 0; i < names.length; i++) {
        for (let j = i + 1; j < names.length; j++) {
          const a = names[i], b = names[j];
          const count = pubMap.get(a).filter(name => name === b).length +
                        pubMap.get(b).filter(name => name === a).length;
          if (count >= 2) conflicts.push({ a, b, count });
        }
      }

      // Render results
      const out = document.getElementById("results");
      if (conflicts.length === 0) {
        out.innerHTML = "<p>No conflicts detected (≥2 co-authored papers in 3 years).</p>";
        return;
      }
      let html = "<table><tr><th>Author A</th><th>Author B</th><th>Co-authored Papers (last 3 years)</th></tr>";
      for (const {a, b, count} of conflicts) {
        html += `<tr><td>${a}</td><td>${b}</td><td>${count}</td></tr>`;
      }
      html += "</table>";
      out.innerHTML = html;
    }
  </script>
</body>
</html>
